# Cosmic Harmonics - Script Documentation

**Last Updated:** (Set this to today's date)
**Current Phase:** Phase 1: Prototyping (MVP) - Basic UI Flow and ESC Navigation Implemented

---

## Table of Contents

1.  **Core Systems (`Assets/_Project/Scripts/Core/Input/`)**
    -   `InputManager.cs`
    -   `PlayerControls.cs` (Auto-generated by Input System)
2.  **Gameplay Systems (`Assets/_Project/Scripts/Gameplay/`)**
    -   `LevelManager.cs`
    -   `SeedController.cs`
    -   `GravityWell_Star.cs`
    -   `StabilityZone.cs`
3.  **UI Systems (`Assets/_Project/Scripts/UI/`)**
    -   `MainMenuController.cs`
    -   `GameplayUIController.cs`

---

## 1. Core Systems

### 1.1. `InputManager.cs`

**File Path:** `Assets/_Project/Scripts/Core/Input/InputManager.cs`

**Purpose:**
Handles player input for flicking actions, reset requests, and game pause/stop requests (ESC key) using Unity's new Input System. It detects mouse gestures, converts screen coordinates to world coordinates, and communicates with `LevelManager` to control seed aiming/launching and UI/game state changes. Manages an internal `_isGameCurrentlyPlaying` flag to enable/disable input processing based on game state.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** None (but it references `Camera.main` and interacts with `LevelManager.Instance`).

**Public Members (Runtime & Events):**

-   **`public static InputManager Instance { get; private set; }`**
    -   A static property for implementing the Singleton pattern.
-   **`public Vector2 FlickStartPosition { get; private set; }`**
    -   The world-space coordinates where the flick gesture started.
-   **`public Vector2 FlickEndPosition { get; private set; }`**
    -   The world-space coordinates where the flick gesture ended.
-   **`public bool IsFlicking { get; private set; }`**
    -   A boolean flag indicating if a flick gesture is currently in progress.
-   **`public event System.Action<Vector2> OnFlickStart;`**
    -   Event fired when a flick gesture begins. Parameter: world-space start position.
-   **`public event System.Action<Vector2, Vector2> OnFlickEnd;`**
    -   Event fired when a flick gesture completes. Parameters: world-space start and end positions.

**Key Methods:**

-   **`private void Awake()`**
    -   Implements Singleton pattern. Initializes `_playerControls` and caches `_mainCamera`.
-   **`private void Update()`**
    -   If `_isGameCurrentlyPlaying` is true, not flicking, and an aimable seed exists, continuously calls `LevelManager.Instance.UpdateActiveSeedAimPosition()` with the current mouse world position.
-   **`private void OnEnable()` / `private void OnDisable()`**
    -   Subscribes/unsubscribes to `_playerControls.Gameplay.FlickPress` (started/canceled), `_playerControls.Gameplay.ResetAction` (performed), and `_playerControls.Gameplay.StopGame` (performed) events. Enables/disables the "Gameplay" action map.
-   **`public void SetGamePlayingState(bool isPlaying)`**
    -   Sets the internal `_isGameCurrentlyPlaying` flag. Called by `LevelManager` and `MainMenuController` to control input processing.
-   **`private void OnStopGamePerformed(InputAction.CallbackContext context)`**
    -   Called when the `StopGame` action (ESC key) is performed.
    -   If `_isGameCurrentlyPlaying` is true and `Time.timeScale` is not `0f` (i.e., game is active and not already paused by UI), calls `LevelManager.Instance.ReturnToMainMenu()` and sets `_isGameCurrentlyPlaying = false`.
-   **`private void OnFlickPressStarted(InputAction.CallbackContext context)`**
    -   If `_isGameCurrentlyPlaying` and a seed is ready for launch, sets `IsFlicking = true`.
    -   Records `FlickStartPosition`. Invokes `OnFlickStart` event.
-   **`private void OnFlickPressCanceled(InputAction.CallbackContext context)`**
    -   If `IsFlicking` and `_isGameCurrentlyPlaying`, sets `IsFlicking = false`. Records `FlickEndPosition`.
    -   Calls `LevelManager.Instance.RequestLaunchActiveSeed()`. Invokes `OnFlickEnd` event.
-   **`private void OnResetActionPerformed(InputAction.CallbackContext context)`**
    -   If `_isGameCurrentlyPlaying`, calls `LevelManager.Instance.RequestManualReset()`.
-   **`public Vector2 GetPointerPositionInWorld()`**
    -   Reads pointer screen position, converts to world coordinates using `_mainCamera`.

**Dependencies:**

-   `PlayerControls.cs` (auto-generated input class).
-   `LevelManager.cs` (for controlling seed aiming, launch, reset, and game state changes).
-   A `Camera` tagged "MainCamera" in the scene.

---

### 1.2. `PlayerControls.cs` (Auto-generated)

**File Path:** `Assets/_Project/Scripts/Core/Input/PlayerControls.cs`

**Purpose:**
Auto-generated by Unity's Input System (version `1.13.1` or as per file) based on the `PlayerControls.inputactions` asset. Provides a C# interface to defined Action Maps, Actions, and Bindings. **This script should NOT be manually edited.**

**Key Auto-generated Content (Relevant to Gameplay Action Map):**

-   **Action Map:** `Gameplay`
    -   **Action:** `FlickPress` (Button, bound to Mouse Left Button)
    -   **Action:** `PointerPosition` (Value, Vector2, bound to Mouse Position)
    -   **Action:** `ResetAction` (Button, bound to Mouse Right Button)
    -   **Action:** `StopGame` (Button, bound to Keyboard Escape key) - _New_

---

## 2. Gameplay Systems

### 2.1. `LevelManager.cs`

**File Path:** `Assets/_Project/Scripts/Gameplay/LevelManager.cs`

**Purpose:**
Orchestrates level setup, manages the lifecycle of the active seed (spawning, aiming, launching, stabilization), checks win conditions, and handles UI transitions (Start Menu, Gameplay UI, Level Complete). Communicates game state changes to `InputManager`.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** None (but instantiates prefabs and references other controllers/camera).

**Public Members (Serialized Fields for Inspector):**

-   **`[SerializeField] private GameObject seedPrefab;`**
-   **`[SerializeField] private GameObject starPrefab;`**
-   **`[SerializeField] private GameObject stabilityZonePrefab;`**
-   **`[SerializeField] private Vector2 initialSeedPosition;`**
-   **`[SerializeField] private Vector2 starSpawnPosition;`**
-   **`[SerializeField] private Vector2 stabilityZoneSpawnPosition;`**
-   **`[SerializeField] private Vector2 stabilityZoneScale;`**
-   **`[Header("UI References")]`**
    -   **`[SerializeField] private GameplayUIController gameplayUIController;`**
    -   **`[SerializeField] private MainMenuController mainMenuController;`**

**Public Members (Runtime):**

-   **`public static LevelManager Instance { get; private set; }`** (Singleton instance)
-   **`public SeedController _activeSeed { get; private set; }`** (Reference to the current seed)

**Key Methods:**

-   **`private void Awake()`**
    -   Implements Singleton. Caches `_mainCamera`. Checks Inspector assignments for `gameplayUIController` and `mainMenuController`.
-   **`public void StartLevel()`**
    -   Called by `MainMenuController`. Clears/resets previous level if needed.
    -   Shows `GameplayUI` via `gameplayUIController`. Sets `Time.timeScale = 1f`.
    -   Calls `SetupLevel()`. Informs `InputManager` that game is playing (`SetGamePlayingState(true)`).
-   **`private void SetupLevel()`**
    -   Calls `ClearLevelObjects()`. Instantiates Star, Stability Zone, and calls `SpawnSeed()`.
    -   Sets `_levelSetupComplete = true`, `_levelCompleted = false`.
-   **`private void ClearLevelObjects()`**
    -   Helper method to destroy `_activeSeed`, `_spawnedStar`, and `_spawnedStabilityZone`. Unsubscribes from seed events.
-   **`public void SpawnSeed()`**
    -   Instantiates `seedPrefab`, gets `SeedController`, prepares it for aiming, subscribes to its events.
-   **`public void UpdateActiveSeedAimPosition(Vector2 mouseWorldPosition)`** (Called by `InputManager`)
-   **`public void RequestLaunchActiveSeed(Vector2 flickStartPosition, Vector2 flickEndPosition)`** (Called by `InputManager`)
-   **`private void HandleSeedLaunched(SeedController seed)`** (Event handler)
-   **`private void HandleSeedStabilized(SeedController stabilizedSeed)`** (Event handler)
    -   Sets `_levelCompleted = true`. Informs `InputManager` game is not actively playing.
    -   Calls `gameplayUIController.ShowLevelCompletePanel()`.
-   **`private void CheckSeedOutOfBounds()`** (Called in `Update`)
-   **`public void RequestManualReset()`** (Called by `InputManager`)
    -   Resets `_activeSeed`, `_levelCompleted`. Informs `InputManager` game is playing.
-   **`private void ResetActiveSeed()`**
-   **`private void ResetLevelInternally()`**
-   **`public void ReturnToMainMenu()`**
    -   Calls `ClearLevelObjects()`. Informs `InputManager` game is not playing.
    -   Calls `gameplayUIController.HideGameplayUI()`. Calls `mainMenuController.ShowMenu()`.
-   **`private void CheckWinCondition()`** (Called in `Update`)
-   **`public void ResetLevel()`** (Public method for full level restart)
-   **`private void OnDestroy()`**
    -   Unsubscribes from `_activeSeed` events.

**Dependencies:**

-   `InputManager.cs` (to update game playing state).
-   `SeedController.cs` (as prefab and for event subscription).
-   `GameplayUIController.cs` (for managing gameplay UI).
-   `MainMenuController.cs` (for showing the main menu).
-   `GravityWell_Star.cs`, `StabilityZone.cs` (as prefabs).
-   A `Camera` tagged "MainCamera".

---

## _(Documentation for `SeedController.cs`, `GravityWell_Star.cs`, `StabilityZone.cs` would remain here as per previous state, assuming no changes to them in this session.)_

## 3. UI Systems

### 3.1. `MainMenuController.cs`

**File Path:** `Assets/_Project/Scripts/UI/MainMenuController.cs`

**Purpose:**
Manages the Start Menu UI Canvas. Handles the "Start Game" button press to initiate gameplay via `LevelManager` and provides a method to show/activate the main menu, typically when returning from gameplay or on game launch.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** Typically attached to the `StartMenuCanvas` GameObject. Needs UI elements assigned in Inspector.

**Public Members (Serialized Fields for Inspector):**

-   **`[Header("UI Elements")]`**
    -   **`[SerializeField] private Button startGameButton;`**
-   **`[Header("Controller References")]`**
    -   **`[SerializeField] private GameplayUIController gameplayUIController;`**

**Key Methods:**

-   **`private void Start()`**
    -   Assigns `startGameButton.onClick` listener to `HandleStartGame`.
    -   Ensures `gameplayUIController` is assigned and calls its `HideGameplayUI()` method.
    -   Calls `ShowMenu()` to set the initial state (menu visible, game paused).
-   **`private void HandleStartGame()`**
    -   Disables the `StartMenuCanvas`'s GameObject.
    -   Calls `LevelManager.Instance.StartLevel()` to begin gameplay.
-   **`public void ShowMenu()`**
    -   Activates the `StartMenuCanvas`'s GameObject.
    -   Sets `Time.timeScale = 0f` to pause game logic.
    -   Calls `gameplayUIController.HideGameplayUI()` to ensure gameplay elements are hidden.
    -   Calls `InputManager.Instance.SetGamePlayingState(false)` to indicate game is not actively playing.
-   **`private void OnDestroy()`**
    -   Removes `startGameButton.onClick` listener.

**Dependencies:**

-   `LevelManager.cs` (to start the level).
-   `GameplayUIController.cs` (to hide gameplay UI elements).
-   `InputManager.cs` (to set game playing state).
-   Unity UI `Button` component.

---

### 3.2. `GameplayUIController.cs`

**File Path:** `Assets/_Project/Scripts/UI/GameplayUIController.cs`

**Purpose:**
Manages the `GameplayUICanvas`, which contains UI elements visible during active gameplay. Specifically handles the display and interaction of the `LevelCompletePanel`.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** Typically attached to the `GameplayUICanvas` GameObject. Needs UI elements assigned in Inspector.

**Public Members (Serialized Fields for Inspector):**

-   **`[Header("Panels")]`**
    -   **`[SerializeField] private GameObject levelCompletePanel;`**
-   **`[Header("Buttons")]`**
    -   **`[SerializeField] private Button returnToMenuButtonLevelComplete;`**
-   **`[Header("Controller References")]`**
    -   **`[SerializeField] private MainMenuController mainMenuController;`** (Primarily for fallback if LevelManager is missing)

**Key Methods:**

-   **`private void Awake()`**
    -   Ensures `levelCompletePanel` is initially hidden.
    -   Assigns `returnToMenuButtonLevelComplete.onClick` listener to `HandleReturnToMenu`.
    -   Checks for `mainMenuController` assignment.
-   **`public void ShowLevelCompletePanel()`**
    -   Activates `levelCompletePanel`.
    -   Sets `Time.timeScale = 0f` to pause game.
-   **`public void HideLevelCompletePanel()`**
    -   Deactivates `levelCompletePanel`.
-   **`private void HandleReturnToMenu()`**
    -   Calls `HideLevelCompletePanel()`.
    -   Deactivates the `GameplayUICanvas`'s GameObject.
    -   Calls `LevelManager.Instance.ReturnToMainMenu()` to handle level cleanup and transition to main menu.
    -   Includes a fallback to directly call `mainMenuController.ShowMenu()` if `LevelManager` is missing.
-   **`public void ShowGameplayUI()`**
    -   Activates the `GameplayUICanvas`'s GameObject.
    -   Ensures `levelCompletePanel` is hidden via `HideLevelCompletePanel()`.
-   **`public void HideGameplayUI()`**
    -   Deactivates the `GameplayUICanvas`'s GameObject.
-   **`private void OnDestroy()`**
    -   Removes `returnToMenuButtonLevelComplete.onClick` listener.

**Dependencies:**

-   `LevelManager.cs` (to initiate return to main menu sequence).
-   `MainMenuController.cs` (for fallback return to menu).
-   Unity UI `Button` and `GameObject` for panel management.

---
