# Cosmic Harmonics - Script Documentation

This document provides an overview of the C# scripts created for the "Cosmic Harmonics" project, detailing their purpose, public members, and key methods.

**Last Updated:** (Set this to today's date)
**Current Phase:** Phase 1: Prototyping (MVP) - Level Manager & Reset Logic Implemented

---

## Table of Contents

1.  **Core Systems (`Assets/_Project/Scripts/Core/Input/`)**
    -   `InputManager.cs`
    -   `PlayerControls.cs` (Auto-generated by Input System)
2.  **Gameplay Systems (`Assets/_Project/Scripts/Gameplay/`)**
    -   `LevelManager.cs`
    -   `SeedController.cs`
    -   `GravityWell_Star.cs`
    -   `StabilityZone.cs`

---

## 1. Core Systems

### 1.1. `InputManager.cs`

**File Path:** `Assets/_Project/Scripts/Core/Input/InputManager.cs`

**Purpose:**
Handles player input for flicking actions and reset requests using Unity's new Input System. It detects mouse gestures, converts screen coordinates to world coordinates, and communicates with `LevelManager` to control seed aiming, launching, and resetting.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** None (but it references `Camera.main` and `LevelManager.Instance`).

**Public Members:**

-   **`public static InputManager Instance { get; private set; }`**
    -   A static property for implementing the Singleton pattern.
-   **`public Vector2 FlickStartPosition { get; private set; }`**
    -   The world-space coordinates where the flick gesture started (mouse button pressed).
-   **`public Vector2 FlickEndPosition { get; private set; }`**
    -   The world-space coordinates where the flick gesture ended (mouse button released).
-   **`public bool IsFlicking { get; private set; }`**
    -   A boolean flag indicating if a flick gesture is currently in progress.
-   **`public event System.Action<Vector2> OnFlickStart;`**
    -   Event fired when a flick gesture begins. Parameter: world-space start position.
-   **`public event System.Action<Vector2, Vector2> OnFlickEnd;`**
    -   Event fired when a flick gesture completes. Parameters: world-space start and end positions.

**Key Methods:**

-   **`private void Awake()`**
    -   Implements Singleton pattern. Initializes `_playerControls` and caches `_mainCamera`.
-   **`private void Update()`**
    -   If not currently flicking (`!IsFlicking`) and an aimable seed exists (checked via `LevelManager.Instance._activeSeed.IsReadyForAiming`), continuously calls `LevelManager.Instance.UpdateActiveSeedAimPosition()` with the current mouse world position.
-   **`private void OnEnable()` / `private void OnDisable()`**
    -   Subscribes/unsubscribes to `_playerControls.Gameplay.FlickPress` (started/canceled) and `_playerControls.Gameplay.ResetAction` (performed) events. Enables/disables the "Gameplay" action map.
-   **`private void OnFlickPressStarted(InputAction.CallbackContext context)`**
    -   Sets `IsFlicking = true` if a seed is ready for launch (checked via `LevelManager`).
    -   Records `FlickStartPosition`. Invokes `OnFlickStart` event.
-   **`private void OnFlickPressCanceled(InputAction.CallbackContext context)`**
    -   Sets `IsFlicking = false`. Records `FlickEndPosition`. Invokes `OnFlickEnd` event.
    -   Calls `LevelManager.Instance.RequestLaunchActiveSeed()` if a seed is in a launchable state.
-   **`private void OnResetActionPerformed(InputAction.CallbackContext context)`**
    -   Called when the `ResetAction` (e.g., right mouse click) is performed.
    -   Calls `LevelManager.Instance.RequestManualReset()`.
-   **`public Vector2 GetPointerPositionInWorld()`**
    -   Reads pointer screen position, converts to world coordinates using `_mainCamera`.

**Dependencies:**

-   `PlayerControls.cs` (auto-generated input class).
-   `LevelManager.cs` (for controlling seed aiming, launch, and reset).
-   A `Camera` tagged "MainCamera" in the scene.

---

### 1.2. `PlayerControls.cs` (Auto-generated)

**File Path:** `Assets/_Project/Scripts/Core/Input/PlayerControls.cs`

**Purpose:**
Auto-generated by Unity's Input System based on the `PlayerControls.inputactions` asset. Provides a C# interface to defined Action Maps, Actions, and Bindings. **This script should NOT be manually edited.**

**Key Auto-generated Content (Relevant to Gameplay Action Map):**

-   **Action Map:** `Gameplay`
    -   **Action:** `FlickPress` (Button, bound to Mouse Left Button)
    -   **Action:** `PointerPosition` (Value, Vector2, bound to Mouse Position)
    -   **Action:** `ResetAction` (Button, bound to Mouse Right Button) - _New_

---

## 2. Gameplay Systems

### 2.1. `LevelManager.cs`

**File Path:** `Assets/_Project/Scripts/Gameplay/LevelManager.cs`

**Purpose:**
Manages the setup of a basic level, the lifecycle of a single active seed (spawning, aiming, launching, detecting stabilization), checking win conditions, and handling reset requests (manual or due to seed going out of bounds).

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** None (but it instantiates prefabs and references `Camera.main`).

**Public Members (Serialized Fields for Inspector):**

-   **`[SerializeField] private GameObject seedPrefab;`**
-   **`[SerializeField] private GameObject starPrefab;`**
-   **`[SerializeField] private GameObject stabilityZonePrefab;`**
-   **`[SerializeField] private Vector2 initialSeedPosition;`** (Position for seed before mouse aiming)
-   **`[SerializeField] private Vector2 starSpawnPosition;`**
-   **`[SerializeField] private Vector2 stabilityZoneSpawnPosition;`**
-   **`[SerializeField] private Vector2 stabilityZoneScale;`**

**Public Members (Runtime):**

-   **`public static LevelManager Instance { get; private set; }`** (Singleton instance)
-   **`public SeedController _activeSeed;`** (Reference to the current seed; _note: direct public access used for `InputManager`_)

**Key Methods:**

-   **`private void Awake()`**
    -   Implements Singleton. Caches `_mainCamera = Camera.main`.
-   **`private void Start()`**
    -   Calls `SetupLevel()`.
-   **`private void Update()`**
    -   If level is active and not complete, checks if the active seed is out of camera bounds (`CheckSeedOutOfBounds()`).
    -   Calls `CheckWinCondition()`.
-   **`private void SetupLevel()`**
    -   Instantiates Star and Stability Zone from prefabs at configured positions/scales.
    -   Calls `SpawnSeed()`. Sets `_levelSetupComplete = true`, `_levelCompleted = false`.
-   **`public void SpawnSeed()`**
    -   Instantiates `seedPrefab` if no active seed exists or resets existing one.
    -   Calls `_activeSeed.PrepareForAiming()` with `initialSeedPosition`.
    -   Subscribes to `_activeSeed.OnSeedStabilized` and `_activeSeed.OnSeedLaunched`.
-   **`public void UpdateActiveSeedAimPosition(Vector2 mouseWorldPosition)`**
    -   Calls `_activeSeed.UpdateAimPosition()` if the seed is ready for aiming.
-   **`public void RequestLaunchActiveSeed(Vector2 flickStartPosition, Vector2 flickEndPosition)`**
    -   If `_activeSeed` is ready (not launched/stable), calculates `flickVector` and calls `_activeSeed.Launch()`.
    -   Ignores request if seed is already launched or stable.
-   **`private void HandleSeedLaunched(SeedController seed)`**
    -   Logs seed launch.
-   **`private void HandleSeedStabilized(SeedController stabilizedSeed)`**
    -   Sets `_levelCompleted = true` if not already, logs "LEVEL COMPLETE!".
-   **`private void CheckSeedOutOfBounds()`**
    -   If active, launched, non-stable seed is outside camera viewport (plus buffer), calls `ResetActiveSeed()`.
-   **`public void RequestManualReset()`**
    -   Called by `InputManager` on right-click. Calls `ResetActiveSeed()`. Resets `_levelCompleted`.
-   **`private void ResetActiveSeed()`**
    -   Calls `_activeSeed.PrepareForAiming(initialSeedPosition)` and resets `_levelCompleted`.
-   **`public void ResetLevel()`**
    -   Destroys existing spawned level elements (Star, Zone, Seed - using `FindObjectsByType`) and re-calls `Start()` (which calls `SetupLevel()`).
-   **`private void CheckWinCondition()`**
    -   If `_activeSeed` is stable and `_levelCompleted` is false, sets `_levelCompleted = true` and logs "LEVEL COMPLETE!".
-   **`private void OnDestroy()`**
    -   Unsubscribes from `_activeSeed` events.

**Dependencies:**

-   `SeedController.cs`
-   `InputManager.cs` (indirectly, as `InputManager` calls its public methods)
-   `GravityWell_Star.cs` (as a prefab)
-   `StabilityZone.cs` (as a prefab)
-   A `Camera` tagged "MainCamera".
-   Scene GameObjects named `// -- ENVIRONMENT --` and `// -- DYNAMIC_OBJECTS --` if parenting instantiated objects.

---

### 2.2. `SeedController.cs`

**File Path:** `Assets/_Project/Scripts/Gameplay/SeedController.cs`

**Purpose:**
Manages behavior of an individual "celestial seed," including aiming, physics, launch, state (kinematic for aiming, dynamic when launched, stabilizing, stable), interaction with stability zones, and visual feedback.

**Inheritance:** `MonoBehaviour`

**Key Components Required on GameObject:** `Rigidbody2D`, `CircleCollider2D`, `SpriteRenderer`.

**Public Members (Serialized Fields for Inspector):**

-   **`public float launchForceMultiplier = 10f;`**
-   **`public float stabilizationTimeRequired = 2f;`**
-   **`public float quasiStationaryVelocityThreshold = 0.1f;`**
-   **`[SerializeField] private float defaultDrag = 0.1f;`** (Refers to `Rigidbody2D.linearDamping`)
-   **`[SerializeField] private float dragInStabilityZone = 2f;`** (Refers to `Rigidbody2D.linearDamping`)
-   **`public Color flyingColor = Color.white;`**
-   **`public Color stabilizingColor = Color.yellow;`**
-   **`public Color stableColor = Color.green;`**

**Public Members (Runtime & Events):**

-   **`public event Action<SeedController> OnSeedStabilized;`**
-   **`public event Action<SeedController> OnSeedLaunched;`**
-   **`public bool IsLaunched { get; }`**
-   **`public bool IsStable { get; }`**
-   **`public bool IsReadyForAiming { get; }`** (True if not launched, not stable, and Rigidbody2D is Kinematic)

**Key Methods:**

-   **`private void Awake()`**
    -   Caches `Rigidbody2D`, `SpriteRenderer`. Sets initial color and `_rb.linearDamping = defaultDrag`.
-   **`private void Update()`**
    -   Handles stabilization logic if launched, not stable, and in a stability zone. Checks velocity against `quasiStationaryVelocityThreshold`, manages `_stabilizationTimer`, updates color, and invokes `OnSeedStabilized` when stable. Resets stabilization progress if seed moves too fast or exits zone while stabilizing.
-   **`public void PrepareForAiming(Vector2 initialPosition)`**
    -   Sets seed's `transform.position`. Sets `_rb.bodyType = RigidbodyType2D.Kinematic`, resets velocities and `_rb.linearDamping = defaultDrag`. Resets all state flags (`_isLaunched`, `_isStable`, etc.).
-   **`public void UpdateAimPosition(Vector2 worldPosition)`**
    -   If `IsReadyForAiming`, sets `transform.position = worldPosition`.
-   **`public void Launch(Vector2 flickVector)`**
    -   If not stable, sets `_rb.bodyType = RigidbodyType2D.Dynamic`, `_rb.linearDamping = defaultDrag`.
    -   Applies force: `_rb.AddForce(flickVector * launchForceMultiplier, ForceMode2D.Impulse)`.
    -   Sets `_isLaunched = true`, resets other relevant states, invokes `OnSeedLaunched`.
-   **`public void EnterStabilityZone(StabilityZone zone)`**
    -   Sets flags (`_isInStabilityZone`, `_currentStabilityZone`). If `_rb` is dynamic, sets `_rb.linearDamping = dragInStabilityZone`.
-   **`public void ExitStabilityZone(StabilityZone zone)`**
    -   Resets zone-related flags. If `_rb` is dynamic, reverts `_rb.linearDamping = defaultDrag`. Updates color if not stable.
-   **`public void ResetSeed(Vector2 startPosition)`**
    -   Sets `_rb.linearDamping = defaultDrag`, then calls `PrepareForAiming(startPosition)`.
-   **`private void SetColor(Color newColor)`**
    -   Helper to change `SpriteRenderer` color.

**Dependencies:**

-   `LevelManager.cs` (to call `PrepareForAiming`, `UpdateAimPosition`, `Launch`, `ResetSeed`).
-   `StabilityZone.cs` (to call `EnterStabilityZone`, `ExitStabilityZone`).
-   Requires `Rigidbody2D`, `CircleCollider2D`, `SpriteRenderer` on the same GameObject.

---

### 2.3. `GravityWell_Star.cs`

**File Path:** `Assets/_Project/Scripts/Gameplay/GravityWell_Star.cs`

**Purpose:**
Defines the behavior of a fixed "Star" gravity well. It exerts a radial gravitational pull on any GameObjects tagged "Seed" that enter its defined effect radius.
_(No changes reported for this script in the last session, content remains as previously documented)._

**Key Public Members:**

-   **`public float gravityStrength = 50f;`**
-   **`public float effectRadius = 5f;`**

---

### 2.4. `StabilityZone.cs`

**File Path:** `Assets/_Project/Scripts/Gameplay/StabilityZone.cs`

**Purpose:**
Defines a zone where "Seeds" can attempt to stabilize. It detects seeds entering and exiting its trigger volume and notifies the `SeedController` accordingly. It also provides visual feedback for its active state.
_(No changes reported for this script in the last session, content remains as previously documented)._

**Public Members (Serialized Fields):**

-   **`[SerializeField] private Color activeColor`**
-   **`[SerializeField] private Color inactiveColor`**

---
