# Cosmic Harmonics - Implementation Log

**Last Updated:** (2025-06-02) <--- _You can update this date as you work_
**Current Blueprint Phase:** Phase 1: Prototyping (MVP)
**Current Focus:** Project Setup & Initial Scene Configuration

---

## Phase 1: Prototyping (MVP) - Initial Setup

### 1. Unity Project Creation & Configuration

-   **Unity Version:** 2022.3.x LTS (or latest stable LTS at time of creation)
-   **Project Template:** 2D (URP)
    -   _If 2D (URP) template wasn't used, URP was installed manually via Package Manager._
-   **Render Pipeline:** Universal Render Pipeline (URP)
    -   Created URP Asset (e.g., `CosmicHarmonics_URPAsset`) with a 2D Renderer.
    -   Assigned URP Asset in `Project Settings > Graphics`.
    -   Assigned URP Asset in `Project Settings > Quality` for all quality levels.
-   **Target Platform (Initial Focus):** PC (Windows, macOS, Linux)

### 2. Version Control (Git & LFS)

-   **Git Repository:** Initialized in the project root directory.
-   **`.gitignore` File:** Created in the project root with Unity-specific and IDE-specific ignores as per blueprint.
-   **Git LFS (Large File Storage):**
    -   Installed and initialized (`git lfs install`).
    -   Tracked file types:
        -   `*.png`, `*.jpg`, `*.jpeg`, `*.gif`
        -   `*.psd`
        -   `*.ogg`, `*.wav`, `*.mp3`
        -   `*.asset`
    -   `.gitattributes` file created/updated.
-   **Branching Strategy:**
    -   `main` branch: For stable, releasable states.
    -   `develop` branch: Created and checked out for ongoing development.
-   **Initial Commits:**
    1.  `Initial commit: Setup .gitignore and Git LFS`
    2.  `feat: Initial Unity project structure` (covering Assets/, ProjectSettings/, Packages/)

### 3. Project Folder Structure (within `Assets/`)

-   Created main project folder: `_Project`
-   **Subfolders within `Assets/_Project/`:**
    -   `Animations`
    -   `Audio`
        -   `Music`
        -   `SFX`
    -   `Fonts`
    -   `Materials`
    -   `Prefabs`
        -   `Characters`
        -   `Environment`
        -   `FX`
        -   `UI`
    -   `Scenes`
        -   `_Main`
        -   `_Levels`
    -   `ScriptableObjects`
        -   `Levels`
        -   `SeedTypes`
        -   `EventChannels`
    -   `Scripts`
        -   `Core`
        -   `Gameplay`
        -   `Editor`
        -   `UI`
    -   `Shaders`
    -   `Sprites` (or `Textures`)
        -   `UI`
        -   `Gameplay`

### 4. Initial Scene Setup & Camera Configuration

-   **Scene Created:** `MainGameplay_Prototype.unity` (or similar, e.g., `Level_00_Sandbox.unity`)
-   **Scene Location:** Saved in `Assets/_Project/Scenes/_Main/` (or `_Levels/`)
-   **Main Camera (`Main Camera` GameObject):**
    -   **Transform:**
        -   Position: `(X: 0, Y: 0, Z: -10)`
    -   **Camera Component:**
        -   Projection: `Orthographic`
        -   Size: `5` (initial value, adaptable)
        -   Clipping Planes: Near `0.3`, Far `1000`
        -   Rendering > Renderer: Linked to URP's 2D Renderer.
        -   Environment > Background Type: `Solid Color`
        -   Background Color: Set to a dark cosmic theme (e.g., R:20, G:20, B:40 or R:10, G:5, B:15).
        -   Post Processing: Checkbox **enabled**.
-   **Scene Hierarchy Organization (Initial Empty GameObjects):**
    -   `// -- MANAGERS --`
    -   `// -- ENVIRONMENT --`
    -   `// -- DYNAMIC_OBJECTS --`
    -   `// -- UI --`

### 5. Save & Commit Progress

-   Project and Scene saved.
-   **Git Commit:** `feat: Initial project and scene setup with URP camera`
-   Changes pushed to `develop` branch on remote repository (if applicable).

---

---

### 6. Input System Setup (New Unity Input System)

-   **Package Installation:**
    -   Installed "Input System" package (version 1.x.x - _you can check the exact version in Package Manager if desired_) via Package Manager.
    -   Project active input handling set to "Input System Package (New)" in `Edit > Project Settings > Player > Other Settings` (Unity restarted).
-   **Input Actions Asset:**
    -   Created `PlayerControls.inputactions` asset in `Assets/_Project/Scripts/Core/Input/`.
    -   The associated C# class `PlayerControls.cs` was generated by Unity in the same folder (`Assets/_Project/Scripts/Core/Input/PlayerControls.cs`).
    -   **Action Map:** `Gameplay`
        -   **Action:** `FlickPress`
            -   Type: `Button`
            -   Binding: `Mouse / LeftButton`
        -   **Action:** `PointerPosition`
            -   Type: `Value`
            -   Control Type: `Vector2`
            -   Binding: `Mouse / position`
    -   Saved asset and ensured "Generate C# Class" was checked in Inspector, then clicked "Apply".
-   **`InputManager.cs` Script:**
    -   Created `InputManager.cs` in `Assets/_Project/Scripts/Core/Input/`
    -   Implemented Singleton pattern for easy access (`InputManager.Instance`).
    -   Cached `Camera.main` in `Awake()`.
    -   Instantiated `PlayerControls` in `Awake()`.
    -   Subscribed to `_playerControls.Gameplay.FlickPress.started` and `_playerControls.Gameplay.FlickPress.canceled` events in `OnEnable()`, unsubscribed in `OnDisable()`.
    -   `OnFlickPressStarted(InputAction.CallbackContext context)`:
        -   Sets `IsFlicking = true`.
        -   Records `FlickStartPosition` (world coordinates) using `GetPointerPositionInWorld()`.
        -   Invokes `OnFlickStart` event (optional, but good for future decoupling).
        -   Logs flick start screen and world positions.
    -   `OnFlickPressCanceled(InputAction.CallbackContext context)`:
        -   Sets `IsFlicking = false` if it was true.
        -   Records `FlickEndPosition` (world coordinates).
        -   Invokes `OnFlickEnd` event.
        -   Logs flick end screen and world positions, and the calculated flick vector in world coordinates.
    -   `GetPointerPositionInWorld()`:
        -   Reads screen position from `_playerControls.Gameplay.PointerPosition.ReadValue<Vector2>()`.
        -   Converts to world coordinates using `_mainCamera.ScreenToWorldPoint()`.
        -   Returns a `Vector2` (x, y) for 2D gameplay.
-   **Scene Integration:**
    -   Created an empty GameObject named `InputManager` (typically under `// -- MANAGERS --` in the scene hierarchy).
    -   Attached `InputManager.cs` script to this GameObject.
-   **Testing & Verification:**
    -   Confirmed in Play mode via Console logs that:
        -   `FlickPress.started` triggers `OnFlickPressStarted` on mouse button down.
        -   `FlickPress.canceled` triggers `OnFlickPressCanceled` on mouse button release.
        -   Screen and World coordinates for flick start/end are logged correctly.
        -   A non-zero flick vector (World) is calculated and logged.

---

---

### 7. Basic Seed Implementation

-   **Sprite Creation:**
    -   Used a built-in Unity 2D Sprite (`Circle`) named `Seed_Circle_Sprite` located in `Assets/_Project/Sprites/Gameplay/`.
    -   Sprite configured with default `Pixels Per Unit` (e.g., 100).
-   **Seed GameObject (`Seed_Prototype`):**
    -   Created a 2D Sprite GameObject in the scene named `Seed_Prototype`.
    -   Assigned the `Seed_Circle_Sprite` to its `Sprite Renderer` component.
    -   Initial Transform: Position `(0,0,0)`, Scale `(1,1,1)`.
-   **Physics Components on `Seed_Prototype`:**
    -   **`Rigidbody 2D`:**
        -   Body Type: `Dynamic`
        -   Collision Detection: `Discrete` (initially)
        -   Constraints: `Freeze Rotation Z` enabled.
        -   Global Gravity (Project Settings > Physics 2D > Gravity Y) set to `0` for cosmic feel.
    -   **`Circle Collider 2D`:**
        -   Is Trigger: `false`
        -   Radius adjusted to match sprite visuals.
-   **`SeedController.cs` Script:**
    -   Created `SeedController.cs` in `Assets/_Project/Scripts/Gameplay/`.
    -   Attached to `Seed_Prototype` GameObject.
    -   `[RequireComponent(typeof(Rigidbody2D), typeof(CircleCollider2D))]` attributes added.
    -   `Awake()`: Caches `Rigidbody2D`.
    -   `launchForceMultiplier`: Public float to adjust flick strength (default e.g., 10f).
    -   `Launch(Vector2 flickVector)`:
        -   Checks `_isLaunched` flag to prevent multiple launches.
        -   Sets `rb.bodyType = RigidbodyType2D.Dynamic` if it was `Kinematic`.
        -   Applies `flickVector * launchForceMultiplier` using `rb.AddForce(..., ForceMode2D.Impulse)`.
        -   Sets `_isLaunched = true`.
        -   Logs launch details.
    -   `ResetSeed(Vector2 startPosition)`:
        -   Sets `rb.linearVelocity` and `rb.angularVelocity` to zero.
        -   Updates `transform.position`.
        -   Resets `_isLaunched = false`.
        -   Logs reset action.
-   **Temporary Integration with `InputManager.cs` for Testing:**
    -   Added `public SeedController testSeedToLaunch;` field to `InputManager`.
    -   In `InputManager.OnFlickPressCanceled()`:
        -   Calculated `flickVector`.
        -   If `testSeedToLaunch` is assigned:
            -   Set `testSeedToLaunch.transform.position = FlickStartPosition`.
            -   Called `testSeedToLaunch.ResetSeed(FlickStartPosition)`.
            -   Called `testSeedToLaunch.Launch(flickVector)`.
    -   Assigned the `Seed_Prototype` instance from the scene to the `Test Seed To Launch` slot on the `InputManager` GameObject in the Inspector.
-   **Prefab Creation:**
    -   Created a prefab from `Seed_Prototype` by dragging it into `Assets/_Project/Prefabs/Characters/`.
    -   The instance in the scene (`Seed_Prototype`) was kept for direct testing with `InputManager`.
-   -   **Testing & Verification:**
    -   Confirmed in Play mode:
        -   The `Seed_Prototype` GameObject is launched when the mouse is flicked.
        -   The direction and force of the launch correspond to the flick gesture.
        -   The seed moves according to 2D physics and does not fall due to global gravity (Y=0).
        -   _(Note: Without any drag implemented at this stage, the seed will continue moving indefinitely if unobstructed)._
        -   Repeated flicks correctly reset and relaunch the seed from the new flick start position.
        -   The `isKinematic` obsolete warning was resolved by using `rb.bodyType`.
        -   Previous `NullReferenceException`s in `InputManager` were resolved, and `_playerControls` initializes and functions correctly.

---

---

### 8. Gravity Well (Star - Basic) Implementation

-   **Sprite Creation for Star:**

    -   Utilized Unity's built-in `Hexagon - Point Top` 2D Sprite.
    -   Asset named `Star_Sprite` (or similar), located in `Assets/_Project/Sprites/Gameplay/`.
    -   Default Sprite Importer Settings for `Hexagon - Point Top`:
        -   Texture Type: `Sprite (2D and UI)`
        -   Sprite Mode: `Multiple`
        -   Pixels Per Unit: `256`

-   **Star GameObject (`Star_GravityWell`):**

    -   A 2D Sprite GameObject, `Star_GravityWell`, was created in the scene.
    -   The `Star_Sprite` (Hexagon - Point Top) was assigned to its `Sprite Renderer`.
    -   `Sprite Renderer` Color: Configured to a yellowish hue.
    -   Initial Transform: Positioned strategically in the scene (e.g., `(X: 3, Y: 2, Z: 0)`).

-   **Physics Components on `Star_GravityWell`:**

    -   **`Circle Collider 2D`:**
        -   `Is Trigger`: Enabled.
        -   `Radius`: Set to define the gravitational influence range (e.g., `3` or `5` units), intended to be synced with `effectRadius` in the `GravityWell_Star` script.

-   **`GravityWell_Star.cs` Script:**

    -   Script created in `Assets/_Project/Scripts/Gameplay/` and attached to `Star_GravityWell`.
    -   `[RequireComponent(typeof(CircleCollider2D))]` attribute included.
    -   **Key Public Properties:**
        -   `gravityStrength`: Float, controls the magnitude of the gravitational pull (e.g., `50f`).
        -   `effectRadius`: Float, defines the range of gravitational effect (e.g., `5f`).
    -   **Core Logic:**
        -   `Awake()`: Caches `CircleCollider2D`, ensures it's a trigger, and initializes `_effectCollider.radius` from `effectRadius`.
        -   `FixedUpdate()`: Iterates through `affectedRigidbodies`. Applies a force towards the star on each seed within range using `rb.AddForce(directionToWell * gravityStrength, ForceMode2D.Force)`. Includes logic to clean up null/inactive rigidbodies.
        -   `OnTriggerEnter2D()`: Detects GameObjects tagged "Seed" entering the trigger, adding their `Rigidbody2D` to `affectedRigidbodies`.
        -   `OnTriggerExit2D()`: Detects GameObjects tagged "Seed" exiting the trigger, removing their `Rigidbody2D` from `affectedRigidbodies`.
        -   `OnDrawGizmosSelected()`: Provides editor visualization of `effectRadius`.
        -   `OnValidate()`: Attempts to synchronize `_effectCollider.radius` with `effectRadius` for editor-time changes.

-   **Seed Prefab Tagging:**

    -   The `Seed_Prototype` prefab and its scene instances were assigned the tag "Seed".

-   **Configuration & Prefab Creation:**

    -   `Gravity Strength` and `Effect Radius` values were configured on the `Star_GravityWell` instance.
    -   A prefab of `Star_GravityWell` was created and stored in `Assets/_Project/Prefabs/Environment/`.

-   **Testing & Verification:**
    -   Functional Test: Seeds flicked within the `effectRadius` of the `Star_GravityWell` are observably pulled towards its center.
    -   Debugging: Console logs confirm seed entry and exit from the star's trigger zone.
    -   Behavioral Observation: Initial interactions (capture, orbit attempts, sling-shots) between flicked seeds and the gravity well were noted.
    -   _(Note on Live Editing: Current script version may require a stop/play cycle for Inspector changes to `gravityStrength` and `effectRadius` to reliably update the physics simulation during Play mode)._

---

---

---

### 9. Stability Zone (Basic) Implementation

-   **Goal:** Create a zone where seeds can detect entry/exit and become "stable" if they remain quasi-stationary for a set duration.
-   **Sprite & GameObject:**
    -   Created a `StabilityZone_Sprite` (e.g., using Unity's built-in Square sprite) in `Assets/_Project/Sprites/Gameplay/`.
    -   Created a 2D Sprite GameObject `StabilityZone_Prototype` in the scene under `// -- ENVIRONMENT --`.
    -   Assigned the sprite and a distinct color (e.g., light blue, semi-transparent).
    -   Positioned and scaled for testing.
-   **Collider:**
    -   Added a `BoxCollider2D` (or `CircleCollider2D` depending on sprite choice) to `StabilityZone_Prototype`.
    -   Collider size adjusted to match visuals.
    -   **`Is Trigger` enabled.**
-   **`StabilityZone.cs` Script:**
    -   Created `StabilityZone.cs` in `Assets/_Project/Scripts/Gameplay/` and attached to `StabilityZone_Prototype`.
    -   `Awake()`: Caches `SpriteRenderer`.
    -   `OnTriggerEnter2D(Collider2D other)`:
        -   Checks for "Seed" tag.
        -   Gets `SeedController` from the seed.
        -   Calls `seed.EnterStabilityZone(this)`.
        -   Changes zone's `SpriteRenderer` color for feedback (e.g., to an "active" color).
        -   Logs entry.
    -   `OnTriggerExit2D(Collider2D other)`:
        -   Checks for "Seed" tag.
        -   Gets `SeedController` from the seed.
        -   Calls `seed.ExitStabilityZone(this)`.
        -   Reverts zone's `SpriteRenderer` color (e.g., to an "inactive" color).
        -   Logs exit.
    -   `OnDrawGizmos()`: Added to visualize the zone's collider in the editor.
-   **`SeedController.cs` Modifications:**
    -   **New Properties:**
        -   `stabilizationTimeRequired` (float, e.g., 2f): Time needed to become stable.
        -   `quasiStationaryVelocityThreshold` (float, e.g., 0.1f): Max velocity to be considered for stabilization.
        -   `flyingColor`, `stabilizingColor`, `stableColor`: For visual feedback.
    -   **State Variables:**
        -   `_currentStabilityZone` (StabilityZone)
        -   `_stabilizationTimer` (float)
        -   `_isStabilizing` (bool)
        -   `_isStable` (bool)
        -   `_isInStabilityZone` (bool)
    -   `Awake()`: Caches `SpriteRenderer`.
    -   `EnterStabilityZone(StabilityZone zone)`:
        -   Sets `_isInStabilityZone = true`, `_currentStabilityZone = zone`.
        -   Resets `_stabilizationTimer` and `_isStabilizing`.
    -   `ExitStabilityZone(StabilityZone zone)`:
        -   Sets `_isInStabilityZone = false`, `_currentStabilityZone = null`.
        -   Resets `_isStabilizing`, `_stabilizationTimer`.
        -   Reverts color if not stable.
    -   `Update()` (or `FixedUpdate()`):
        -   If `_isLaunched`, `!_isStable`, `_isInStabilityZone`:
            -   Checks if `_rb.velocity.magnitude < quasiStationaryVelocityThreshold`.
            -   If true: starts/continues `_stabilizationTimer`, sets `_isStabilizing = true`, changes color to `stabilizingColor`.
            -   If timer exceeds `stabilizationTimeRequired`: sets `_isStable = true`, changes color to `stableColor`, logs stability.
            -   If false (moved too fast): resets `_stabilizationTimer`, `_isStabilizing = false`, reverts color.
    -   `ResetSeed(Vector2 startPosition)`: Updated to reset all new stabilization state variables (`_isStabilizing`, `_isStable`, `_isInStabilityZone`, `_currentStabilityZone`, `_stabilizationTimer`) and color.
    -   `Launch(Vector2 flickVector)`: Prevents launch if `_isStable`. Sets seed color to `flyingColor`.
-   **Seed Tagging:** Ensured `Seed_Prototype` prefab is tagged "Seed".
-   **Testing & Verification:**
    -   Flicked seed into the zone. Observed console logs for entry/exit.
    -   Observed zone color changes on seed entry/exit.
    -   Manually placed seed in the zone (or flicked very gently) to test stabilization:
        -   Seed color changed to `stabilizingColor` when quasi-stationary.
        -   After `stabilizationTimeRequired`, seed color changed to `stableColor` and "STABLE" message logged.
    -   Tested moving the seed out of the zone while stabilizing (stabilization stops/resets).
    -   Tested moving the seed too fast within the zone (stabilization timer resets).
    -   _(Note: Initial tests for making the seed stop used temporary `Linear Damping` on the Seed's Rigidbody2D. This was reverted to 0 after confirming basic zone logic, as permanent damping affects other interactions like gravity well capture too much. The method for how seeds naturally slow down in stability zones will be revisited.)_

---

---

### 10. Basic Level Manager & Gameplay Loop

-   **Goal:** Implement a `LevelManager` to control a basic level setup, manage a single seed's lifecycle (spawn, launch, stabilization), check for a win condition, and handle reset conditions.
-   **`LevelManager.cs` Script:**
    -   Created `LevelManager.cs` in `Assets/_Project/Scripts/Gameplay/`.
    -   Implemented Singleton pattern (`LevelManager.Instance`).
    -   **Responsibilities:**
        -   Spawns a Star, Stability Zone, and one Seed from assigned prefabs at configured positions (`initialSeedPosition`, `starSpawnPosition`, `stabilityZoneSpawnPosition`). Scales the Stability Zone.
        -   Caches `Camera.main`.
        -   The active seed is initially `Kinematic` and follows the mouse cursor for aiming (`UpdateActiveSeedAimPosition` called by `InputManager`).
        -   `RequestLaunchActiveSeed(flickStart, flickEnd)`: Called by `InputManager`. Launches the active seed if it's ready (not already launched/stable). Further flicks on a launched/stable seed are ignored.
        -   Subscribes to `_activeSeed.OnSeedStabilized` and `_activeSeed.OnSeedLaunched` events.
        -   `HandleSeedStabilized()`: Sets `_levelCompleted = true` and logs "LEVEL COMPLETE!" when the active seed stabilizes.
        -   `CheckSeedOutOfBounds()`: Called in `Update()`. If a launched, non-stable seed goes outside camera viewport (with a buffer), it resets the seed to `initialSeedPosition` (ready for aiming).
        -   `RequestManualReset()`: Public method to reset the active seed to `initialSeedPosition` (and `_levelCompleted` to false). Can be triggered by `InputManager`.
        -   `ResetLevel()`: Clears spawned level objects (Stars, Zones, Seed using `FindObjectsByType`) and re-runs `SetupLevel()`.
-   **`SeedController.cs` Modifications:**
    -   Added `IsReadyForAiming` public property.
    -   Added `PrepareForAiming(Vector2 initialPosition)`: Sets seed to `Kinematic`, resets state, positions it.
    -   Added `UpdateAimPosition(Vector2 worldPosition)`: Updates transform position if `IsReadyForAiming`.
    -   `Launch()`: Sets Rigidbody to `Dynamic`, applies force, sets `_isLaunched = true`. Ensures `drag` is set to `defaultDrag`.
    -   `ResetSeed(Vector2 startPosition)`: Now calls `PrepareForAiming()`.
    -   Added `defaultDrag` and `dragInStabilityZone` serialized fields.
    -   `Awake()`: Sets `_rb.drag = defaultDrag`.
    -   `EnterStabilityZone()`: Sets `_rb.drag = dragInStabilityZone` if seed is `Dynamic`.
    -   `ExitStabilityZone()`: Reverts `_rb.drag = defaultDrag` if seed is `Dynamic`.
    -   Seed prefab default `Rigidbody2D.bodyType` set to `Kinematic`.
-   **`InputManager.cs` Modifications:**
    -   `Update()`: If not flicking and an aimable seed exists, calls `LevelManager.Instance.UpdateActiveSeedAimPosition()`.
    -   `OnFlickPressStarted()`: Checks if seed is ready for launch before setting `IsFlicking = true`.
    -   `OnFlickPressCanceled()`: Calls `LevelManager.Instance.RequestLaunchActiveSeed()`.
    -   Added `ResetAction` (mapped to Right Mouse Button) to `PlayerControls.inputactions`.
    -   Added `OnResetActionPerformed()`: Calls `LevelManager.Instance.RequestManualReset()` when `ResetAction` is performed.
-   **Scene Integration:**
    -   Removed manually placed Star, Zone, and Seed from the scene.
    -   Created `LevelManager` GameObject and attached the script.
    -   Assigned necessary prefabs (Seed, Star, Stability Zone) to `LevelManager` in the Inspector.
    -   Configured `initialSeedPosition` and other spawn points/scales.
-   **Testing & Verification:**
    -   Level objects (Star, Zone, Seed) spawn correctly.
    -   Seed follows mouse cursor before launch.
    -   Seed launches from mouse click position.
    -   Seed physics (gravity, drag in zone) and stabilization work as expected.
    -   "LEVEL COMPLETE!" message appears on stabilization.
    -   Flicking again after launch/stabilization is ignored for the active seed.
    -   Seed resets to initial aimable position if it goes off-screen.
    -   Right-clicking resets the seed to initial aimable position (and level complete status).
    -   Deprecated `FindObjectsOfType<T>()` updated to `FindObjectsByType<T>(FindObjectsSortMode.None)` in `LevelManager.ResetLevel()`.

---
